<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Car Racing Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #111; overflow: hidden; font-family: 'Arial', sans-serif; }
        #gameContainer { position: relative; width: 100vw; height: 100vh; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        
        .control-btn {
            position: absolute;
            bottom: 60px; width: 70px; height: 70px;
            background-color: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.7); border-radius: 50%;
            color: white; font-size: 40px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; user-select: none; z-index: 10;
        }
        .control-btn.positioning { border: 3px dashed #FFD700; animation: pulse-border 1s infinite; cursor: move; }
        @keyframes pulse-border { 0% { border-color: #FFD700; } 50% { border-color: #fff; } 100% { border-color: #FFD700; } }

        #leftButton { left: 20px; }
        #rightButton { right: 20px; }
        
        #startScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        #startScreen h1 { font-size: 10vw; margin-bottom: 20px; text-shadow: 3px 3px 5px #000; }
        
        #difficultySelector { display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .difficulty-btn {
            cursor: pointer; border: none; background: transparent;
            width: 250px; max-width: 60vw; height: 80px;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            transition: transform 0.2s;
        }
        .difficulty-btn:active { transform: scale(0.95); }
        #easyButton { background-image: url('easy.png'); }
        #mediumButton { background-image: url('medium.png'); }
        #hardButton { background-image: url('hard.png'); }

        #settingsButton { position: absolute; top: 20px; right: 20px; width: 50px; height: 50px; background: url('settings.png') no-repeat center center / 70% 70%, rgba(0,0,0,0.5); border-radius: 50%; border: 2px solid white; z-index: 11; cursor: pointer; }
        
        /* --- Styles for Modals (Shop & Settings) --- */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Dark overlay */
            color: white; z-index: 20;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px;
        }
        .modal h2 {
            font-size: 8vw; margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #007BFF; /* Blue underline */
        }
        .modal-content { display: flex; flex-direction: column; gap: 20px; width: 80%; max-width: 400px; text-align: center; }
        #carSelection { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .car-option { background: rgba(255,255,255,0.1); border: 2px solid #4CAF50; border-radius: 10px; padding: 10px; cursor: pointer; transition: all 0.2s; }
        .car-option.selected { border-color: #FFD700; background: rgba(76,175,80,0.5); transform: scale(1.05); }
        .car-option img { width: 80px; height: auto; max-width: 100%; }
        .car-option p { margin-top: 10px; font-weight: bold; }

        .modal-button {
            margin-top: 10px; padding: 18px 30px; font-size: 4.5vw;
            color: white; border: none; border-radius: 12px;
            cursor: pointer; font-weight: bold;
        }
        #closeShopButton { background-color: #2196F3; } /* Blue color */
        #openSettingsButton { background-color: #f44336; } /* Red color */
        #backToShopButton { background-color: #f44336; } /* Red color */
        #positionControlsButton { background-color: #FFC107; color: black; } /* Yellow color */
        #savePositionsButton { background-color: #4CAF50; display: none; } /* Green color */
        
        .settings-option { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .settings-option label { font-size: 4.5vw; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #ddd; border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #007BFF; border-radius: 50%; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: #007BFF; border-radius: 50%; cursor: pointer; }
        
        #magnetTimer { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 10px 20px; border-radius: 20px; font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px; z-index: 5; }
        #magnetTimer img { width: 30px; height: 30px; }

        .hidden { display: none !important; }
        .game-object { position: absolute; filter: drop-shadow(4px 4px 3px rgba(0,0,0,0.5)); }
        #permissionScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; color: white; display: flex; justify-content: center; align-items: center; z-index: 30; cursor: pointer; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="gameObjectContainer"><img id="playerCarElement" class="game-object hidden"></div>
        <div id="leftButton" class="control-btn hidden">◀</div>
        <div id="rightButton" class="control-btn hidden">▶</div>

        <div id="startScreen">
            <h1>Car Racing</h1>
            <div id="difficultySelector">
                <button id="easyButton" class="difficulty-btn"></button>
                <button id="mediumButton" class="difficulty-btn"></button>
                <button id="hardButton" class="difficulty-btn"></button>
            </div>
            <div id="settingsButton"></div>
        </div>
        
        <div id="shopModal" class="modal hidden">
            <div class="modal-content">
                <h2>Choose Your Car</h2>
                <div id="carSelection"></div>
                <button id="openSettingsButton" class="modal-button">Game Settings</button>
                <button id="closeShopButton" class="modal-button">Back to Menu</button>
            </div>
        </div>

        <div id="settingsModal" class="modal hidden">
            <div class="modal-content">
                <h2>Settings</h2>
                <div class="settings-option">
                    <label for="opacitySlider">Controls Opacity</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="40">
                </div>
                <button id="positionControlsButton" class="modal-button">Set Control Position</button>
                <button id="savePositionsButton" class="modal-button">Save Positions</button>
                <button id="backToShopButton" class="modal-button">Back to Shop</button>
            </div>
        </div>

        <div id="magnetTimer" class="hidden"><img src="magnet.png"><span></span></div>
        <div id="permissionScreen"><h2>Tap to Start</h2></div>
    </div>

    <script>
        // === CONFIGURATION AREA ===
        const CONFIG = {
            playerCarWidthPercent: 0.11, playerSpeedMultiplier: 0.0216, roadSpeedMultiplier: 0.006,
            difficulty: { easy: 1.0, medium: 1.1, hard: 1.21 },
            obstacleWidthFactor: 0.75, obstacleSpawnInterval: 120,
            coinSizePercent: 0.15, coinSpawnInterval: 180,
            magnetSizePercent: 0.1, magnetSpawnInterval: 600, magnetDuration: 360 // 6 seconds
        };
        
        // DOM Elements
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        const startScreen = document.getElementById('startScreen'), settingsButton = document.getElementById('settingsButton');
        const shopModal = document.getElementById('shopModal'), closeShopButton = document.getElementById('closeShopButton');
        const settingsModal = document.getElementById('settingsModal'), backToShopButton = document.getElementById('backToShopButton');
        const magnetTimerDiv = document.getElementById('magnetTimer');
        const leftButton = document.getElementById('leftButton'), rightButton = document.getElementById('rightButton');
        const permissionScreen = document.getElementById('permissionScreen');

        // Game State & Data
        let gameState = 'menu', score = 0, difficultyMultiplier = 1.0, selectedCarSrc = 'player_car.png';
        const cars = [
            { name: 'Default Racer', src: 'player_car.png' }, { name: 'Blue Thunder', src: 'player_car_2.png' },
            { name: 'Red Fury', src: 'player_car_3.png' }, { name: 'Green Ghost', src: 'player_car_4.png' },
            { name: 'Yellow Jacket', src: 'player_car_5.png' }
        ];

        // Game Objects
        let assets = {}, playerCar = { element: document.getElementById('playerCarElement'), x: 0, y: 0, magnetActive: false, magnetTimer: 0 };
        let road = {}, coins = [], obstacles = [], magnets = [], D_DIMS = {};
        let coinSpawnTimer = 0, obstacleSpawnTimer = 0, magnetSpawnTimer = 0;

        function setDimensions() {
            canvas.width = gameContainer.clientWidth; canvas.height = gameContainer.clientHeight;
            D_DIMS.roadLeftBoundary = canvas.width * 0.30; D_DIMS.roadRightBoundary = canvas.width * 0.70;
            D_DIMS.playerCarWidth = canvas.width * CONFIG.playerCarWidthPercent; D_DIMS.playerCarHeight = D_DIMS.playerCarWidth * 2;
            D_DIMS.playerCarSpeed = canvas.width * CONFIG.playerSpeedMultiplier * difficultyMultiplier;
            D_DIMS.baseSpeed = canvas.height * CONFIG.roadSpeedMultiplier * difficultyMultiplier;
            D_DIMS.obstacleWidth = D_DIMS.playerCarWidth * CONFIG.obstacleWidthFactor; D_DIMS.obstacleHeight = D_DIMS.playerCarHeight * CONFIG.obstacleWidthFactor;
            D_DIMS.coinSize = canvas.width * CONFIG.coinSizePercent; D_DIMS.magnetSize = canvas.width * CONFIG.magnetSizePercent;
        }

        function startGame(difficulty) {
            difficultyMultiplier = difficulty; setDimensions(); assets.openingSound.pause();
            startScreen.classList.add('hidden'); leftButton.classList.remove('hidden'); rightButton.classList.remove('hidden');
            gameState = 'playing'; resetGame(); playerCar.element.classList.remove('hidden');
            assets.carSound.currentTime = 0; assets.carSound.play();
        }

        function update() {
            if (gameState !== 'playing') return;
            road.y1 += D_DIMS.baseSpeed; road.y2 += D_DIMS.baseSpeed;
            if (road.y1 >= canvas.height) road.y1 = road.y2 - canvas.height; if (road.y2 >= canvas.height) road.y2 = road.y1 - canvas.height;
            if (playerCar.magnetActive) {
                playerCar.magnetTimer--; magnetTimerDiv.querySelector('span').innerText = `${Math.ceil(playerCar.magnetTimer / 60)}s`;
                if (playerCar.magnetTimer <= 0) { playerCar.magnetActive = false; magnetTimerDiv.classList.add('hidden'); }
            }
            if (isMovingLeft) playerCar.x -= D_DIMS.playerCarSpeed; if (isMovingRight) playerCar.x += D_DIMS.playerCarSpeed;
            playerCar.x = Math.max(D_DIMS.roadLeftBoundary, Math.min(playerCar.x, D_DIMS.roadRightBoundary - D_DIMS.playerCarWidth));
            playerCar.element.style.left = `${playerCar.x}px`;
            if (++obstacleSpawnTimer > CONFIG.obstacleSpawnInterval) { obstacles.push(createGameObject('obstacle-car', `obstacle${Math.floor(Math.random()*4)+1}.png`, D_DIMS.obstacleWidth, D_DIMS.obstacleHeight, D_DIMS.baseSpeed + Math.random()*2)); obstacleSpawnTimer=0; }
            if (++coinSpawnTimer > CONFIG.coinSpawnInterval) { coins.push(createGameObject('coin', 'coin.gif', D_DIMS.coinSize, D_DIMS.coinSize, D_DIMS.baseSpeed)); coinSpawnTimer=0; }
            if (++magnetSpawnTimer > CONFIG.magnetSpawnInterval) { magnets.push(createGameObject('magnet-powerup', 'magnet.png', D_DIMS.magnetSize, D_DIMS.magnetSize, D_DIMS.baseSpeed)); magnetSpawnTimer=0; }
            updateAndCheckObjects(coins, (c) => { if (playerCar.magnetActive) { const dx = (playerCar.x + D_DIMS.playerCarWidth / 2) - (c.x + c.width / 2); const dy = (playerCar.y + D_DIMS.playerCarHeight / 2) - (c.y + c.height / 2); if (Math.sqrt(dx * dx + dy * dy) < canvas.width * 0.5) { c.x += dx * 0.1; c.y += dy * 0.1; c.element.style.left = `${c.x}px`; } } if (checkCollision(playerCar, c)) { score += 5; assets.collectSound.currentTime = 0; assets.collectSound.play(); return true; } });
            updateAndCheckObjects(obstacles, (o) => { if (checkCollision(playerCar, o)) { assets.carSound.pause(); assets.hitSound.currentTime = 0; assets.hitSound.play(); gameState = 'gameOver'; setTimeout(showStartScreen, 2000); } });
            updateAndCheckObjects(magnets, (m) => { if (checkCollision(playerCar, m)) { playerCar.magnetActive = true; playerCar.magnetTimer = CONFIG.magnetDuration; magnetTimerDiv.classList.remove('hidden'); return true; } });
        }
        function draw() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(assets.road, 0, road.y1, canvas.width, canvas.height); ctx.drawImage(assets.road, 0, road.y2, canvas.width, canvas.height); if (gameState !== 'menu') draw3DScoreBox(score); if (gameState === 'gameOver') drawGameOver(); }
        
        let isMovingLeft = false, isMovingRight = false;
        function init() {
            loadSettings();
            document.getElementById('easyButton').addEventListener('click', () => startGame(CONFIG.difficulty.easy));
            document.getElementById('mediumButton').addEventListener('click', () => startGame(CONFIG.difficulty.medium));
            document.getElementById('hardButton').addEventListener('click', () => startGame(CONFIG.difficulty.hard));
            const handleTouch = (e, val) => { e.preventDefault(); isMovingLeft = (e.currentTarget === leftButton && val); isMovingRight = (e.currentTarget === rightButton && val); };
            ['mousedown', 'touchstart'].forEach(evt => { leftButton.addEventListener(evt, e => handleTouch(e, true)); rightButton.addEventListener(evt, e => handleTouch(e, true)); });
            ['mouseup', 'mouseleave', 'touchend'].forEach(evt => { leftButton.addEventListener(evt, e => handleTouch(e, false)); rightButton.addEventListener(evt, e => handleTouch(e, false)); });
            permissionScreen.addEventListener('click', () => { permissionScreen.classList.add('hidden'); showStartScreen(); requestAnimationFrame(gameLoop); }, { once: true });
            settingsButton.addEventListener('click', () => { startScreen.classList.add('hidden'); shopModal.classList.remove('hidden'); });
            closeShopButton.addEventListener('click', () => { shopModal.classList.add('hidden'); startScreen.classList.remove('hidden'); });
            document.getElementById('openSettingsButton').addEventListener('click', () => { shopModal.classList.add('hidden'); settingsModal.classList.remove('hidden'); });
            backToShopButton.addEventListener('click', () => { settingsModal.classList.add('hidden'); shopModal.classList.remove('hidden'); });
            const opacitySlider = document.getElementById('opacitySlider');
            opacitySlider.addEventListener('input', e => { const opacity = e.target.value / 100; leftButton.style.backgroundColor = `rgba(0,0,0,${opacity})`; rightButton.style.backgroundColor = `rgba(0,0,0,${opacity})`; localStorage.setItem('controlOpacity', e.target.value); });
            document.getElementById('positionControlsButton').addEventListener('click', enterPositioningMode);
            document.getElementById('savePositionsButton').addEventListener('click', exitPositioningMode);
            populateCarShop();
        }

        function loadSettings() {
            const savedOpacity = localStorage.getItem('controlOpacity') || '40';
            document.getElementById('opacitySlider').value = savedOpacity;
            const opacityValue = savedOpacity / 100;
            leftButton.style.backgroundColor = `rgba(0,0,0,${opacityValue})`; rightButton.style.backgroundColor = `rgba(0,0,0,${opacityValue})`;
            const leftPos = JSON.parse(localStorage.getItem('leftButtonPos')); const rightPos = JSON.parse(localStorage.getItem('rightButtonPos'));
            if(leftPos) { leftButton.style.top = leftPos.top; leftButton.style.left = leftPos.left; leftButton.style.bottom = 'auto'; }
            if(rightPos) { rightButton.style.top = rightPos.top; rightButton.style.left = rightPos.left; rightButton.style.bottom = 'auto'; rightButton.style.right = 'auto'; }
        }

        let dragTarget = null, offsetX, offsetY;
        function enterPositioningMode() {
            [leftButton, rightButton].forEach(btn => {
                btn.classList.add('positioning'); btn.classList.remove('hidden');
                btn.addEventListener('mousedown', startDrag); btn.addEventListener('touchstart', startDrag);
            });
            document.getElementById('positionControlsButton').style.display = 'none'; document.getElementById('savePositionsButton').style.display = 'block';
        }
        function exitPositioningMode() {
            [leftButton, rightButton].forEach(btn => {
                btn.classList.remove('positioning');
                btn.removeEventListener('mousedown', startDrag); btn.removeEventListener('touchstart', startDrag);
                if(gameState === 'menu') btn.classList.add('hidden');
            });
            localStorage.setItem('leftButtonPos', JSON.stringify({ top: leftButton.style.top, left: leftButton.style.left }));
            localStorage.setItem('rightButtonPos', JSON.stringify({ top: rightButton.style.top, left: rightButton.style.left }));
            document.getElementById('positionControlsButton').style.display = 'block'; document.getElementById('savePositionsButton').style.display = 'none';
        }
        function startDrag(e) { e.preventDefault(); dragTarget = e.currentTarget; const event = e.type === 'touchstart' ? e.touches[0] : e; offsetX = event.clientX - dragTarget.offsetLeft; offsetY = event.clientY - dragTarget.offsetTop; document.addEventListener('mousemove', onDrag); document.addEventListener('touchmove', onDrag, { passive: false }); document.addEventListener('mouseup', endDrag); document.addEventListener('touchend', endDrag); }
        function onDrag(e) { if (!dragTarget) return; e.preventDefault(); const event = e.type === 'touchmove' ? e.touches[0] : e; let newLeft = event.clientX - offsetX; let newTop = event.clientY - offsetY;
            newLeft = Math.max(0, Math.min(newLeft, canvas.width - dragTarget.offsetWidth)); newTop = Math.max(0, Math.min(newTop, canvas.height - dragTarget.offsetHeight));
            dragTarget.style.left = `${newLeft}px`; dragTarget.style.top = `${newTop}px`;
            dragTarget.style.bottom = 'auto'; dragTarget.style.right = 'auto';
        }
        function endDrag() { dragTarget = null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('touchmove', onDrag); document.removeEventListener('mouseup', endDrag); document.removeEventListener('touchend', endDrag); }

        // --- Other Utility Functions ---
        function populateCarShop() { const c = document.getElementById('carSelection'); c.innerHTML = ''; cars.forEach(car => { const d = document.createElement('div'); d.className = 'car-option'; if (car.src === selectedCarSrc) d.classList.add('selected'); d.innerHTML = `<img src="${car.src}" alt="${car.name}"><p>${car.name}</p>`; d.addEventListener('click', () => { selectedCarSrc = car.src; document.querySelectorAll('.car-option').forEach(o=>o.classList.remove('selected')); d.classList.add('selected'); }); c.appendChild(d); }); }
        function loadAssets(callback) { const sources={"road":"road.jpg","hitSound":"carhit.mp3","carSound":"carsound.mp3","collectSound":"collect.wav","openingSound":"opening.wav"}; let l=0,t=Object.keys(sources).length; for(let k in sources){assets[k]=new (k.includes('Sound')?Audio:Image)(); assets[k].src=sources[k]; const on_load=()=> {if(++l===t)callback();}; if(k.includes('Sound'))assets[k].oncanplaythrough=on_load; else assets[k].onload=on_load;} assets.carSound.loop=true; }
        function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
        function resetGame() { document.getElementById('gameObjectContainer').innerHTML=''; playerCar.element=document.createElement('img'); playerCar.element.id='playerCarElement'; playerCar.element.className='game-object'; playerCar.element.src=selectedCarSrc; playerCar.element.style.width=`${D_DIMS.playerCarWidth}px`; playerCar.element.style.height=`${D_DIMS.playerCarHeight}px`; document.getElementById('gameObjectContainer').appendChild(playerCar.element); playerCar.x=(canvas.width/2)-(D_DIMS.playerCarWidth/2); playerCar.y=canvas.height-D_DIMS.playerCarHeight-80; playerCar.element.style.left=`${playerCar.x}px`; playerCar.element.style.top=`${playerCar.y}px`; obstacles=[]; coins=[]; magnets=[]; score=0; playerCar.magnetActive=false; magnetTimerDiv.classList.add('hidden'); road={y1:0,y2:-canvas.height}; }
        function showStartScreen() { setDimensions(); resetGame(); gameState='menu'; playerCar.element.classList.add('hidden'); startScreen.classList.remove('hidden'); leftButton.classList.add('hidden'); rightButton.classList.add('hidden'); assets.openingSound.currentTime=0; assets.openingSound.play(); }
        function createGameObject(t,s,w,h,v){const e=document.createElement('img');e.src=s;e.className=`game-object ${t}`;e.style.width=`${w}px`;e.style.height=`${h}px`;const rX=Math.random()*(D_DIMS.roadRightBoundary-D_DIMS.roadLeftBoundary-w)+D_DIMS.roadLeftBoundary;e.style.left=`${rX}px`;e.style.top=`-${h}px`;document.getElementById('gameObjectContainer').appendChild(e);return{element:e,x:rX,y:-h,width:w,height:h,speed:v};}
        function updateAndCheckObjects(a,cb){for(let i=a.length-1;i>=0;i--){const o=a[i];o.y+=o.speed||D_DIMS.baseSpeed;o.element.style.top=`${o.y}px`;let r=false;if(cb)r=cb(o);if(r||o.y>canvas.height){o.element.remove();a.splice(i,1);}}}
        function checkCollision(o1,o2){const r1=o1.element.getBoundingClientRect();const r2=o2.element.getBoundingClientRect();return!(r1.right<r2.left||r1.left>r2.right||r1.bottom<r2.top||r1.top>r2.bottom);}
        function draw3DScoreBox(s){const x=10,y=10,w=150,h=50;ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(x,y,w,h);ctx.fillStyle='white';ctx.font='bold 24px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Score: '+s,x+w/2,y+h/2);}
        function drawGameOver(){ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='white';ctx.font=`bold ${canvas.width*0.1}px Arial`;ctx.textAlign='center';ctx.fillText('GAME OVER',canvas.width/2,canvas.height/2);}
        loadAssets(init);
    </script>
</body>
</html>
